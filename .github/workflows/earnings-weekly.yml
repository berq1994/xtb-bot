# earnings_weekly.py
from __future__ import annotations

from datetime import datetime, timedelta
from zoneinfo import ZoneInfo

from radar.config import load_config
from radar.state import State
from radar.engine import fetch_earnings_calendar
from reporting.telegram import telegram_send_long
from reporting.formatters import format_earnings_weekly


def main() -> None:
    cfg = load_config()
    st = State(cfg.state_dir)

    now = datetime.now(ZoneInfo(cfg.timezone))
    today = now.strftime("%Y-%m-%d")

    # Dedupe: pošli jen 1× za pondělí
    tag = "earnings_weekly"
    if st.already_sent(tag, today):
        print("ℹ️ earnings_weekly už dnes odesláno.")
        return

    days = int(getattr(cfg, "earnings_days_ahead", 7) or 7)
    start = now.date()
    end = (now + timedelta(days=days)).date()

    items = fetch_earnings_calendar(cfg, start.isoformat(), end.isoformat())
    msg = format_earnings_weekly(items, cfg, now, days=days)

    telegram_send_long(cfg, msg)
    st.mark_sent(tag, today)
    st.save()
    print("✅ Earnings weekly sent.")


if __name__ == "__main__":
    main()